
<template>
  <view class="container">
    <view class="top_nav">
      <view :style="{height:statusBarHeight}"></view>
      <view class="top_content">
        <view class="player">
          <image class="img" src="/static/player.png"></image>
        </view>
        <view class="content_btn">
          <view class="content_item">
            <text class="item_title">ÂÖ≥Ê≥®</text>
            <view></view>
          </view>
          <view class="content_item">
            <text class="item_title">ÂêåÂüé</text>
            <view></view>
    		    </view>
          <view class="content_item">
            <text class="item_title i_on">Êé®Ëçê</text>
            <view class="line_on"></view>
          </view>
        </view>
        <view class="search">
          <image class="img" src="/static/search.png"></image>
        </view>
      </view>
    </view>

    <view :style="'width: '+ windowWidth +'px; height: '+ boxStyle.height +'px;'">
      <list @loadmore="getData" @scroll="scrolls" :loadmoreoffset="wHeight*3" :show-scrollbar="false" ref="listBox"
        :pagingEnabled="true" :scrollable="true">
        <!-- Âà∑Êñ∞Ê®°Âùó -->
        <refresh class="refresh" @refresh="onrefresh" @pullingdown="onpullingdown"
          :display="refreshing ? 'show' : 'hide'">
          <loading style="background-color: #FFFFFF;">
            <image src="@/static/img/index/logins.gif"
              :style="'width: 80upx; height: 40upx; margin-top: 80upx; margin-bottom: 30upx; margin-left: '+ (windowWidth - 200) +'px;'">
            </image>
          </loading>
        </refresh>

        <!-- Âæ™ÁéØÊï∞ÊçÆ -->
        <cell v-for="(item,i) in dataList" :key="i">
          <!-- Áî®divÊääËßÜÈ¢ëÊ®°ÁªÑÂ•óËµ∑Êù• -->
          <div :style="'width: '+ windowWidth +'px; height: '+ boxStyle.height +'px;'" @disappear="stop()">
            <view class="root">
              <video v-if="Math.abs(k-i)<=1" :ref="'item'+i" :id="item._id" :loop="true" :src="item.src"
                :muted="item.isplay" @play="playIngs(i)" :enable-progress-gesture="false" :page-gesture="false"
                :controls="false" :http-cache="true" :show-loading="false" :show-fullscreen-btn="false"
                :show-center-play-btn="false" :object-fit="object_fit"
                :style="'width: '+ windowWidth +'px; height: '+ (boxStyle.height-75) +'px;margin-top: 75px;'"
                @timeupdate="timeupdate($event,i)"></video>
            </view>
            <!-- Áõ¥Êé•Áî® view Â∞±Ë°å‰∫ÜÔºå‰∏ÄÊ†∑ÊòØÂèØ‰ª•Ë¶ÜÁõñÂéüÁîüÁªÑ‰ª∂ÁöÑ -->
            <!-- Ëøô‰∏™ÊòØÊöÇÂÅúÊó∂Âá∫Áé∞ÁöÑÂõæÊ†á -->
            <view class="videoHover" @click="tapVideoHover(item.state,$event)" :style="boxStyle">
              <image v-if="item.state=='pause'" class="playState" src="@/static/img/index/play.png"></image>
            </view>
            <view class="userInfo" v-if="dataList[k].isShowProgressBarTime == false">
              <!-- 1.Â§¥ÂÉè -->
<!--              <view class="" style="">
                <image v-if="item.isShowProgressBarTime == false" @click="tozuozhe(item)" class="userAvatar" :src="item.author.href"
                  mode="aspectFill"></image>
                <text class="add">+</text>
              </view> -->
			  <view class="" style="">
			    <image v-if="item.isShowProgressBarTime == false" @click="tozuozhe(item)" class="userAvatar" :src="item.author.href" mode="aspectFill"></image>
			    <text class="add" @click="handleFollow(item)">{{ item.followText }}</text>
			  </view>


              <!-- 2.ÁÇπËµû -->
              <view v-if="item.isShowProgressBarTime == false"  @click="toggleLike(item)"
                style="opacity: 0.9; margin-top: 17px;">
                <image v-if="item.like" src="@/static/img/index/xin.png"
                  style="width: 40px; height: 40px; position: absolute; right: 6px;"></image>
                <image v-if="!item.like" src="@/static/img/index/xin-2.png"
                  style="width: 40px; height: 40px; position: absolute; right: 6px;"></image>
                <text
                  style="color: #FFFFFF; margin-top: 5px; font-size: 14px; text-align: center; margin-top: 40px; font-weight: bold;"
                  :class="{'likeNumActive':item.like}">{{item.like_n}}</text>
              </view>
              <!-- 3.ËØÑËÆ∫ -->
              <view v-if="item.isShowProgressBarTime == false" class="comment" @click="toComment(i)"
                style="opacity: 0.9; margin-top: 17px;">
                <image src="@/static/img/index/liaotian-2.png"
                  style="width: 35px; height: 35px; position: absolute; right: 7px;"></image>
                <text
                  style="color: #FFFFFF; margin-top: 5px; font-size: 14px; font-weight: bold; text-align: center; margin-top: 40px;">{{item.sms_n}}</text>
              </view>
              <!-- 4.ÂàÜ‰∫´ -->
              <view v-if="item.isShowProgressBarTime == false" @click.stop="share"
                style="opacity: 0.9; margin-top: 17px;">
                <image src="@/static/img/index/share-fill.png"
                  style="width: 40px; height: 40px; position: absolute; right: 5px;"></image>
                <text
                  style="color: #FFFFFF; margin-top: 5px; font-size: 14px; text-align: center; font-weight: bold; margin-top: 40px;">ÂàÜ‰∫´</text>
              </view>
            </view>
            <!-- Âî±Áâá -->
            <view v-if="item.isShowProgressBarTime == false" style="position: absolute; right: 10px;bottom: 20px;">
              <image src="/static/changpian.png" style="width: 50px; height: 50px;"></image>
            </view>
            <!-- ÊúÄÂ∫ï‰∏ãÁöÑÊñáÂ≠óÈÉ®ÂàÜ -->
            <view class="content" :style="'bottom:' + 10 + 'px;width:'+ (windowWidth - 100) +'px;'"
              v-if="!dataList[k].isShowProgressBarTime">
              <text class="userName" :style="'width: '+ (windowWidth - 100) +'px;'">@{{item.author.username}}</text>
              <!-- i={{i}} -->
              <text class="words" :style="'width: '+ (windowWidth - 100) +'px;'">{{item.msg}}</text>
              <!-- ‰ΩúÂìÅÂéüÂ£∞ -->
              <!-- <view style="flex-direction: row;"> -->
              <view class="left_dubbedText" :style="'width: '+ (windowWidth - 200) +'px;'" 
                style="overflow: hidden;">
                <text class="left_dubbedText_text"
                  :style="{transform: `translateX(${translateX}px)`}">{{item.dubbedText}}</text>
              </view>
              <!-- </view> -->
            </view>
            <image v-if="item.isShowimage == true"
              :src="item.src+'?x-oss-process=video/snapshot,t_'+ currenttimes +'000,f_jpg'" mode="aspectFill"
              :style="'width: 120upx; height: 160upx; border-radius: 10upx; position: absolute; bottom: '+ (ProgressBarBottom + 90) +'upx; left: '+ (currentPositions - 15) +'px;'">
            </image>
          </div>
        </cell>
      </list>
      <!-- 1.Ê≥®ÊÑèÔºöËøõÂ∫¶Êù°ËøôÁ±ªÊãñÊãΩÁöÑ‰∏úË•ø‰∏çËÉΩÊîæËøõblock\cellËøô‰∫õÂæ™ÁéØ‰Ωì‰∏≠ÁöÑÔºåË¶Å‰∏çÁÑ∂touchmoveÊñπÊ≥ï‰ºöÊçïÊçâÊúâËØØ -->
      <view v-if="dataList[k].isShowProgressBarTime == true"
        :style="'position: absolute; bottom: '+ (ProgressBarBottom + 30) +'upx; left: '+ (windowWidth*2 - 550) +'upx;'">
        <text style="font-size: 18px; color: #F1F1F1;">{{changeTime}} / {{videoTimes}}</text>
      </view>
      <!-- ËøôÈáåÂ∞±ÊòØËøõÂ∫¶Êù°‰∫ÜÔºöÁ∫ØÊâãÂ∑•ËøõÂ∫¶Êù°ÔºåË∞ÉÊï¥‰ΩçÁΩÆÁöÑËØùÂ∞±Êää‰ªñ‰ª¨ÁöÑ bottom ÊîπÊàê‰∏Ä‰∏ãÂ∞±Ë°å‰∫Ü -->
      <view v-if="isDragging == false" @touchmove="touchmove" @touchend="touchend" @touchstart="touchstart"
        :style="'position: absolute; bottom: '+ (ProgressBarBottom - 40) +'upx; left: 0;'">
        <!-- 1.Ëøô‰∏ÄÊ≠•ÂøÖÈ°ªÂä†Ôºå‰∏∫‰∫ÜÈÄÇÈÖç‰ΩéÁ´ØÊú∫Âûã -->
        <text :style="'width: '+ windowWidth +'px; opacity: 0;'">.</text>
        <!-- 2.ËøôÊòØÊú™Âä†ËΩΩÁöÑÊó∂ÁöÑÂè≥ËæπÁöÑÁÅ∞Ëâ≤ÈÉ®ÂàÜ -->
        <view
          :style="'width: '+ windowWidth +'px; height: 4upx; background-color: #C8C7CC; position: absolute; bottom: '+ ProgressBarBottom +'upx; opacity: '+ ProgressBarOpacity +';'">
        </view>
        <!-- 3.ËøôÈáåÊàëÈááÁî®ÁöÑÂàÜÁ¶ªÂºèÂäûÊ≥ïÔºöÂ∞±ÊòØËÆ©ÊªëÂä®Ê†∑ÂºèÂíå‰∏çÊªëÂä®ÁöÑÊ†∑ÂºèÂàÜÂºÄÔºåËøôÊ†∑Áõ∏‰∫í‰∏çÂπ≤Êâ∞ÔºåÂèØ‰ª•ÈÅøÂÖçËøõÂ∫¶Êù°Èó™Âä®ÁöÑÈóÆÈ¢ò -->
        <!-- 4.Ê≥®ÊÑèÔºöisShowProgressBarTime Âä†ÂÖ•‰∫ÜËøîÂõûÊï∞ÊçÆ‰∏≠ -->
        <view v-if="dataList[k].isShowProgressBarTime == false"
          :style="'width: '+ (currentPosition) +'px; height: 4upx; background-color: #FFFFFF; position: absolute; bottom: '+ ProgressBarBottom +'upx; left: 0; opacity: '+ (ProgressBarOpacity - 0.1) +';'">
        </view>
        <view v-if="dataList[k].isShowProgressBarTime == true"
          :style="'width: '+ (currentPositions) +'px; height: 8upx; background-color: #FFFFFF; position: absolute; bottom: '+ ProgressBarBottom +'upx; left: 0; opacity: '+ (ProgressBarOpacity + 0.05) +';'">
        </view>
        <view v-if="dataList[k].isShowProgressBarTime == false"
          :style="'width: 4px; height: 4px; background-color: #FFFFFF; border-radius: 10px; position: absolute; bottom: '+ (ProgressBarBottom - 2) +'upx; left: '+ (currentPosition) +'px; opacity: '+ ProgressBarOpacity +';'">
        </view>
        <view v-if="dataList[k].isShowProgressBarTime == true"
          :style="'width: '+ dotWidth +'px; height: '+ dotWidth +'px; background-color: #FFFFFF; border-radius: 10px; position: absolute; bottom: '+ (ProgressBarBottom - 5) +'upx; left: '+ (currentPositions - 5) +'px; opacity: '+ ProgressBarOpacity +';'">
        </view>
      </view>
    </view>
  </view>
</template>
<script>
  export default {
    data() {
      return {
		  id: 0,
		  token: uni.getStorageSync('token'), // ‰ªéÊú¨Âú∞Â≠òÂÇ®‰∏≠Ëé∑Âèñtoken‰ø°ÊÅØ,
		  followText: '+',
        //‰∏ãÈù¢ÊâìüåüÂè∑ÁöÑÊòØÂøÖÈ°ªË¶ÅÁöÑÂü∫Á°ÄÂ≠óÊÆµ
        //‰∏ãÈù¢ÊâìüíóÂè∑ÁöÑÊòØÊã•ÊúâÊªëÂä®Êù°ÁöÑÂøÖÈ°ªÂ≠óÊÆµ
        dataList: [], //Áî®‰∫éÊï∞ÊçÆÂæ™ÁéØÁöÑÂàóË°®üåüüíó
		userList:[],
		dataList2: [], //Áî®‰∫éÊï∞ÊçÆÂæ™ÁéØÁöÑÂàóË°®üåüüíó
		userList2:[],
        wHeight: 0, //Ëé∑ÂèñÁöÑÂ±èÂπïÈ´òÂ∫¶üåüüíó
        boxStyle: { //ËßÜÈ¢ëÔºåÂõæÁâáÂ∞ÅÈù¢Ê†∑Âºèüåüüíó
          'height': 0,
          'width': 0,
        },
		state: 'stop',
		showComment: false, // ÊéßÂà∂ËØÑËÆ∫ÂàóË°®ÁöÑÊòæÁ§∫‰∏éÈöêËóè
	    commentList: [], // Â≠òÂÇ®ËØÑËÆ∫ÂàóË°®Êï∞ÊçÆ
        k: 0, //ÈªòËÆ§‰∏∫0üåüüíó
        playIngIds: [], //Ê≠£Âú®Êí≠ÊîæÁöÑËßÜÈ¢ëidÂàóÈòüÔºåÂàóÈòüÁî®‰∫éÂ§ÑÁêÜÊªëÂä®ËøáÂø´ÂØºËá¥ÁöÑË∑≥È¢ëÈóÆÈ¢òüåüüíó
        ready: false, //ÂèØÂøΩÁï•
        isDragging: false, //false‰ª£Ë°®ÂÅúÊ≠¢ÊªëÂä®üåüüíó
        refreshing: true, //Áî®‰∫é‰∏ãÊãâÂà∑Êñ∞üåüüíó
        windowWidth: 0, //Ëé∑ÂèñÂ±èÂπïÂÆΩÂ∫¶üåüüíó
        dex: [0, 0], //Áî®‰∫éÂà§Êñ≠ÊòØ‰∏äÊªëËøòÊòØ‰∏ãÊªëÔºåÁ¨¨‰∏Ä‰∏™Â≠òÊóßÂÄºÔºåÁ¨¨‰∫å‰∏™Â≠òÊñ∞ÂÄº„ÄêÁõÆÂâçÂú®1.0.7Â∑≤ÁªèÂ∫üÂºÉ„Äë
        currents: 0, //Áî®‰∫éÂ∑¶Âè≥ÊªëÂä®Ôºå0‰ª£Ë°®ËßÜÈ¢ëÁïåÈù¢Ôºå1‰ª£Ë°®Âè≥ÊªëÁïåÈù¢üåüüíó
        platform: '', //Áî®‰∫éËé∑ÂèñÊìç‰ΩúÁ≥ªÁªüÔºöios„ÄÅandroidüåüüíó
        playIng: false, //Áî®‰∫éËßÜÈ¢ëÂàùÂßãÂåñÊó∂ÊòØÂê¶Êí≠ÊîæÔºåÈªòËÆ§‰∏çÊí≠Êîæüåüüíó
        videoTime: '', //ËßÜÈ¢ëÊÄªÊó∂ÈïøÔºåËøô‰∏™‰∏ªË¶ÅÁî®Êù•Êà™ÂèñÊó∂Èó¥Êï∞ÂÄºüíó
        videoTimes: '', //ËßÜÈ¢ëÊó∂ÈïøÔºåÁî®Ëøô‰∏™Êù•Ëé∑ÂèñÊó∂Èó¥ÂÄºÔºå‰æãÂ¶ÇÔºö00:30Ëøô‰∏™Êó∂Èó¥ÂÄºüíó
        changeTime: '', //ÊòæÁ§∫ÊªëÂä®ËøõÂ∫¶Êù°Êó∂ÂèòÂåñÁöÑÊó∂Èó¥üíó
        isShowimage: false, //ÊòØÂê¶ÊòæÁ§∫Â∞ÅÈù¢„Äê1.0.4Â∑≤Â∫üÂºÉÔºå‰ΩÜÊòØÊÑèÊÄùÈúÄË¶ÅËÆ∞‰Ωè„Äë
        currenttimes: 0, //ÂΩìÂâçÊó∂Èó¥üíó
        isShowProgressBarTime: false, //ÊòØÂê¶ÊãñÂä®ËøõÂ∫¶Êù°ÔºåÂ¶ÇÊûúÊãñÂä®ÔºàtrueÔºâÂàôÊòæÁ§∫ËøõÂ∫¶Êù°Êó∂Èó¥ÔºåÂê¶Âàô‰∏çÊòæÁ§∫ÔºàfalseÔºâ„Äê1.0.4Â∑≤Â∫üÂºÉÔºå‰ΩÜÊòØÊÑèÊÄùÈúÄË¶ÅËÆ∞‰Ωè„Äë
        ProgressBarOpacity: 0.7, //ËøõÂ∫¶Êù°‰∏çÊãñÂä®Êó∂ÁöÑÈªòËÆ§ÂÄºÔºåÂ∞±ÊòØÈÄèÊòéÁöÑüíó
        dotWidth: 0, //Êí≠ÊîæÁöÑÂ∞èÂúÜÁÇπÔºåÈªòËÆ§Ê≤°Êúâüíó
        deleteHeight: 0, //ÊµãËØïÈ´òÂ∫¶üåüüíó
        percent: 0, //ÁôæÂàÜÂ∞èÊï∞üíó
        currentPosition: 0, //ÊªëÂùóÂΩìÂâç‰ΩçÁΩÆüíó//2.0Â∑≤ÂºÉÁî®ÔºåÁé∞Â∑≤Áî®‰∫éÂêéÁ´ØÂèÇÊï∞
        currentPositions: 0, //ÊªëÂùóÂΩìÂâç‰ΩçÁΩÆÁöÑÂâØÊú¨üíó//2.0Â∑≤ÂºÉÁî®ÔºåÁé∞Â∑≤Áî®‰∫éÂêéÁ´ØÂèÇÊï∞
        newTime: 0, //Ë∑üÊâãÊªëÂä®ÂêéÁöÑÊúÄÊñ∞Êó∂Èó¥üíó
        timeNumber: 0, //üåüüíó
        ProgressBarBottom: 20, //ËøõÂ∫¶Êù°Á¶ªÂ∫ïÈÉ®ÁöÑË∑ùÁ¶ªüíó
        object_fit: 'fill', //ËßÜÈ¢ëÊ†∑ÂºèÈªòËÆ§ÂåÖÂê´üåüüíó
        mode: 'aspectFit', //ÂõæÁâáÂ∞ÅÈù¢Ê†∑Âºèüåüüíó
        timeout: "", //üåüÁî®Êù•ÈòªÊ≠¢ setTimeout()ÊñπÊ≥ï
        voice: "", //üåüÁî®Êù•ÈòªÊ≠¢ setTimeout()ÊñπÊ≥ï
        oldVideo: "",

        statusBarHeight: 0,
        translateX: '10',
		timer:null,
		signature:'',
		background_image:'',
		follow_count:0,
		follower_count:0,
		is_follow:0,
		total_favorited:0,
		work_count:0,
		favorite_count:0,
		user_id:0,
      }
    },
    watch: {
      k(k, old_k) { //ÁõëÂê¨ k ÂÄºÁöÑÂèòÂåñÔºåÂèØ‰ª•ÊéßÂà∂ËßÜÈ¢ëÁöÑÊí≠Êîæ‰∏éÊöÇÂÅú
        console.log(k)
        this.dataList[old_k].state = 'stop' //Â¶ÇÊûúÊòØË¢´ÊªëËµ∞ÁöÑËßÜÈ¢ëÔºåÂ∞±ÂÅúÊ≠¢Êí≠Êîæ
        this.dataList[old_k].playIng = false //Â¶ÇÊûúËßÜÈ¢ëÊöÇÂÅúÔºåÂ∞±Âä†ËΩΩÂ∞ÅÈù¢
        this.dataList[old_k].isplay = true
        uni.createVideoContext(this.dataList[old_k]._id, this).play()
        clearTimeout(this.oldVideo)
        this.oldVideo = setTimeout(() => {
          uni.createVideoContext(this.dataList[old_k]._id, this).seek(0)
          uni.createVideoContext(this.dataList[old_k]._id, this).pause()
          console.log('È¢ÑÁïôÁ¨¨' + (old_k + 1) + '‰∏™ËßÜÈ¢ëÔºö' + this.dataList[old_k]._id)
        }, 500)
        // uni.createVideoContext(this.dataList[old_k]._id + '' + old_k,this).stop()//Â¶ÇÊûúËßÜÈ¢ëÊöÇÂÅúÔºåÈÇ£‰πàÊóßËßÜÈ¢ëÂÅúÊ≠¢ÔºåËøôÈáåÁöÑthis.dataList[old_k]._id + '' + old_kÔºåÂêéÈù¢Âä† old_k ÊòØ‰∏∫‰∫ÜÊØè‰∏Ä‰∏™ËßÜÈ¢ëÁöÑ id ÂÄº‰∏çÂêåÔºåËøôÊ†∑Â∞±ÂèØ‰ª•Â§ßÁ®ãÂ∫¶ÁöÑÈÅøÂÖç‰∏≤Èü≥ÈóÆÈ¢ò
        console.log('Â∑≤ÁªèÊöÇÂÅú --> Á¨¨' + (old_k + 1) + '‰∏™ËßÜÈ¢ëÔΩû') //ÊèêÁ§∫
        uni.createVideoContext(this.dataList[k]._id, this).play()
        clearTimeout(this.voice)
        this.voice = setTimeout(() => {
          this.dataList[k].isplay = false
        }, 300)
        setTimeout(() => {
          this.dataList[k].playIng = true
        }, 850)
        var p = k
          ++p
        setTimeout(() => {
          uni.createVideoContext(this.dataList[p]._id, this).play()
        }, 20)
        clearTimeout(this.timeout)
        this.timeout = setTimeout(() => {
          uni.createVideoContext(this.dataList[p]._id, this).seek(0)
          uni.createVideoContext(this.dataList[p]._id, this).pause()
          console.log('È¢ÑÂä†ËΩΩÁ¨¨' + (p + 1) + '‰∏™ËßÜÈ¢ëÔºö' + this.dataList[p]._id)
        }, 1500)
      }
    },
	onUnload() {
	  clearInterval(this.timer);
	  clearTimeout(this.timeout);
	},

    onShow() {
      this.animateTranslateX()
      console.log('ÂõûÂà∞ÂâçÂè∞');
      this.dataList[this.k].state = 'play';
      uni.createVideoContext(this.dataList[this.k]._id, this).play()
    },
    onHide() {
      this.dataList[this.k].state = 'pause'; //ÁïåÈù¢ÈöêËóè‰πüË¶ÅÂÅúÊ≠¢Êí≠ÊîæËßÜÈ¢ë
      uni.createVideoContext(this.dataList[this.k]._id, this).pause(); //ÊöÇÂÅú‰ª•ÂêéÁªßÁª≠Êí≠Êîæ
      console.log('Âà∞ÂêéÂè∞');
    },
    onLoad() {
      uni.getSystemInfo({
        success: (e) => {
          this.platform = e.platform //Ëé∑ÂèñÊìç‰ΩúÁ≥ªÁªü
          if (e.model == 'iPhone12' || e.model == 'iPhone11' || e.model == 'iPhoneX') {
            // this.deleteHeight = 32//ËøôÈáåÁöÑÊï∞ÂÄºÂè™ÊòØÂÅöÊ®°ÊãüÔºåÂèØËá™Ë°åÊõ¥Êîπ
            this.deleteHeight = 0 //ËøôÈáåÁöÑÊï∞ÂÄºÂè™ÊòØÂÅöÊ®°ÊãüÔºåÂèØËá™Ë°åÊõ¥Êîπ
          }
        }
      })
      this.statusBarHeight = uni.getSystemInfoSync().statusBarHeight + 'px';

      this.windowWidth = uni.getSystemInfoSync().screenWidth //Ëé∑ÂèñÂ±èÂπïÂÆΩÂ∫¶
      this.boxStyle.width = this.windowWidth + 'px' //ÁªôÂÆΩÂ∫¶Âä†px
      // this.wHeight = uni.getSystemInfoSync().screenHeight;//Ëé∑ÂèñÂ±èÂπïÈ´òÂ∫¶
      this.wHeight = uni.getSystemInfoSync().windowHeight; //Ëé∑ÂèñÂ±èÂπïÂèØÁî®È´òÂ∫¶
      console.log('Â±èÂπïÈ´òÂ∫¶wHeightÔºö', this.wHeight)
      this.boxStyle.height = this.wHeight - this.deleteHeight; //ÂèØ‰ª•Ëá™Ë°åÊõ¥ÊîπËßÜÈ¢ëÈ´òÂ∫¶ÔºåÊÉ≥ËßÜÈ¢ë‰∏çÈÇ£‰πàÈ´òÔºåÂ∞±Êää0ÊîπÂ§ß‰∏ÄÁÇπ
      this.ready = true;
      this.username = uni.getStorageSync('token')
      this.get() //Ëøô‰∏ÄÊ≠•ÔºåÂä†ËΩΩËßÜÈ¢ëÊï∞ÊçÆ
	  this.toggleLike() //Ëøô‰∏ÄÊ≠•ÔºåÁÇπËµûÂä®‰Ωú
    },
	
    onReady() {},
	
	
    methods: {
      // animateTranslateX() {
      //   let num = this.dataList[this.k].dubbedText.length * 5;
      //   timer = setInterval(() => {
      //     this.translateX--
      //     if (this.translateX == -(num + 35)) {
      // 			   this.translateX = num
      //     }
      //   }, 60)
      // },
	 animateTranslateX() {
	   if (this.dataList[this.k]) {
	     let num = this.dataList[this.k].dubbedText.length * 5;
	     this.timer = setInterval(() => {
	       this.translateX--;
	       if (this.translateX == -(num + 35)) {
	         this.translateX = num;
	       }
	     }, 60);
	   } else {
	     console.error("this.dataList[this.k] is undefined:", this.dataList, this.k);
	   }
	 },
	 
	 beforeDestroy() {
	   clearInterval(this.timer);
	 },


      getData() {
        var msg = this.userList
        for (let i = 0; i < 10; i++) {
          this.dataList.push(msg[i])
        }
      },
      touchstart(event) {
        this.dataList[this.k].isShowimage = true //ÂàöËß¶Êë∏ÁöÑÊó∂ÂÄôÂ∞±Ë¶ÅÊòæÁ§∫È¢ÑËßàËßÜÈ¢ëÂõæÁâá‰∫Ü
        this.dataList[this.k].isShowProgressBarTime = true //ÊòæÁ§∫Êó∂Èó¥Á∫ø
        this.ProgressBarOpacity = 1 //ËÆ©ÊªëÂùóÊòæÁ§∫Ëµ∑Êù•Êõ¥ÊòéÊòæ‰∏ÄÁÇπ
        this.dotWidth = 10 //ËÆ©ÁÇπÊòæÁ§∫Ëµ∑Êù•Êõ¥ÊòéÊòæ‰∏ÄÁÇπ
      },
      touchend() { //ÂΩìÊâãÊùæÂºÄÂêéÔºåË∑≥Âà∞ÊúÄÊñ∞Êó∂Èó¥
        uni.createVideoContext(this.dataList[this.k]._id, this).seek(this.newTime)
        if (this.dataList[this.k].state == 'pause') {
          this.dataList[this.k].state = 'play'
          uni.createVideoContext(this.dataList[this.k]._id, this).play()
        }
        this.dataList[this.k].isShowProgressBarTime = false //Ëß¶Êë∏ÁªìÊùüÂêéÔºåÈöêËóèÊó∂Èó¥Á∫ø
        this.dataList[this.k].isShowimage = false //Ëß¶Êë∏ÁªìÊùüÂêéÔºåÈöêËóèÊó∂Èó¥È¢ÑËßà
        this.ProgressBarOpacity = 0.5 //ÈöêËóèËµ∑Êù•ËøõÂ∫¶Êù°Ôºå‰∏çÈÇ£‰πàÊòéÊòæ‰∫Ü
        this.dotWidth = 0 //ÈöêËóèËµ∑Êù•ËøõÂ∫¶Êù°Ôºå‰∏çÈÇ£‰πàÊòéÊòæ‰∫Ü
      },
      touchmove(event) { //ÂΩìÊâãÁßªÂä®ÊªëÂùóÊó∂ÔºåËÆ°ÁÆó‰ΩçÁΩÆ„ÄÅÁôæÂàÜÂ∞èÊï∞„ÄÅÊñ∞ÁöÑÊó∂Èó¥
        var msg = []
        if (this.videoTime !== '') {
          msg = this.videoTime.split(':')
        }
        var timeNumber = Number(msg[0]) * 60 + Number(msg[1])
        this.currentPositions = event.changedTouches[0].screenX
        this.percent = this.currentPositions / this.windowWidth
        this.newTime = this.percent * timeNumber
        this.currenttimes = parseInt(this.newTime)
        let theTime = this.newTime
        let middle = 0; // ÂàÜ
        if (theTime > 60) {
          middle = parseInt(theTime / 60);
          theTime = parseInt(theTime % 60);
        }
        this.changeTime =
          `${Math.round(middle)>9?Math.round(middle):'0'+Math.round(middle)}:${Math.round(theTime)>9?Math.round(theTime):'0'+Math.round(theTime)}`
      },
      timeupdate(event, index) { //ËÆ°ÁÆóÊªëÂùóÂΩìÂâç‰ΩçÁΩÆÔºåËÆ°ÁÆóÂΩìÂâçÁôæÂàÜÂ∞èÊï∞
        // console.log(index)
        if (index == this.k) {
          // console.log(event)
          var currenttime = event.detail.currentTime
          this.timeNumber = Math.round(event.detail.duration)
          this.getTime()
          this.percent = currenttime / this.timeNumber
          this.currentPosition = this.windowWidth * this.percent
          let theTime = currenttime
          let middle = 0; // ÂàÜ
          if (theTime > 60) {
            middle = parseInt(theTime / 60);
            theTime = parseInt(theTime % 60);
          }
          this.changeTime =
            `${Math.round(middle)>9?Math.round(middle):'0'+Math.round(middle)}:${Math.round(theTime)>9?Math.round(theTime):'0'+Math.round(theTime)}`
        }
      },
      getTime() { //ÂæóÂà∞Êó∂Èó¥ÂáΩÊï∞
        this.videoTime = this.formatSeconds(this.timeNumber);
        // console.log(that.videoTime)
        var msg = []
        if (this.videoTime !== '') {
          msg = this.videoTime.split(':')
        }
        this.videoTimes = `${msg[0]>9?msg[0]:'0'+msg[0]}:${msg[1]>9?msg[1]:'0'+msg[1]}`;
      },
      formatSeconds(value) { //Ëé∑ÂèñÊó∂Èó¥ÂáΩÊï∞
        let theTime = parseInt(value); // Áßí
        let middle = 0; // ÂàÜ
        if (theTime > 60) {
          middle = parseInt(theTime / 60);
          theTime = parseInt(theTime % 60);
        }
        return `${middle>9?middle:middle}:${theTime>9?theTime:theTime}`;
      },
	  
      playIngs(index) {
        //
      },
	  
      stop() {
        // console.log('stop')
      },
	  
tozuozhe(item) {
	this.currents = 1;
  console.log('tozuozhe ÊñπÊ≥ïÂ∑≤ÊâßË°å');
  var author1 = JSON.stringify(item.author);
  uni.navigateTo({
	
    url: `/pages/index/follow?author=`+author1,
    success: function(res) {
      console.log('Ë∑≥ËΩ¨ÊàêÂäü', res);
    },
    fail: function(err) {
      console.error('Ë∑≥ËΩ¨Â§±Ë¥•', err);
    }
  });
},


async handleFollow(item) {
	console.log('Clicked:', item);
    try {
	
      const actionType = item.isFollowed ? 2 : 1; // Â¶ÇÊûúÂ∑≤ÂÖ≥Ê≥®ÔºåÂàôÂèñÊ∂àÂÖ≥Ê≥®ÔºõÂ¶ÇÊûúÊú™ÂÖ≥Ê≥®ÔºåÂàôÂÖ≥Ê≥®
      // ÂêëÂêéÁ´ØÂèëÈÄÅÂÖ≥Ê≥®Áä∂ÊÄÅÂèòÊõ¥ËØ∑Ê±Ç
      const response = await uni.request({
        url: `http://192.168.47.9:8080/douyin/relation/action/?to_user_id=${item.author.user_id}&token=${item.author.username}&action_type=${actionType}`,
        method: 'POST',
        dataType: 'json',
      });

      console.log('ÂÖ≥Ê≥®Response:', response);

      if (response[1].data.status_code === 0) {
        // ÊàêÂäüÂ§ÑÁêÜ
        item.isFollowed = !item.isFollowed; // ÂàáÊç¢ÂÖ≥Ê≥®Áä∂ÊÄÅ
        this.updateFollowText(item); // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
		// this.get();
      } else {
        console.error('ÂÖ≥Ê≥®Â§±Ë¥•:', response[1].data.status_msg || 'Unknown Error');
      }
    } catch (error) {
      console.error('ÂÖ≥Ê≥®Â§±Ë¥•:', error);
    }
  },
  
   updateFollowText(item) {
      item.followText = item.isFollowed ? '‚úì' : '+';
    },
	  
	  
	  toComment() {

	  console.log("this.id",this.id)
	  uni.navigateTo({
	    url: `/pages/index/comment?video_id=${this.id}`,
	    success: function(res) {
	      console.log('Ë∑≥ËΩ¨ÊàêÂäü', res);
	    },
	    fail: function(err) {
	      console.error('Ë∑≥ËΩ¨Â§±Ë¥•', err);
	    }
	  });
	  },
	  
	  
	  
	  
	  
      scrolls(event) {
        this.isDragging = event.isDragging
        if (!event.isDragging) { //isDraggingÔºöÂà§Êñ≠Áî®Êà∑ÊòØ‰∏çÊòØÂú®ÊªëÂä®ÔºåÊªëÂä®ÔºötrueÔºåÂÅúÊ≠¢ÊªëÂä®Ôºöfalse„ÄÇÊàë‰ª¨Ë¶ÅÁî®Êà∑ÂÅúÊ≠¢ÊªëÂä®Êó∂ÊâçÁªô k ËµãÂÄºÔºåËøôÊ†∑Â∞±ÂèØ‰ª•ÈÅøÂÖçÂæàÂ§öÈ∫ªÁÉ¶
          var i = Math.round(Math.abs(event.contentOffset.y) / (this.wHeight - this.deleteHeight +
            1)) //ÂÖàÁî®ÁªùÂØπÂÄºÂèñÂá∫ÊªëÂä®ÁöÑË∑ùÁ¶ªÔºåÁÑ∂ÂêéÈô§‰ª•Â±èÂπïÈ´òÂ∫¶ÔºåÂèñ‰∏Ä‰∏™Êï¥ÔºåÂ∞±Áü•ÈÅì‰Ω†Áé∞Âú®ÊªëÂä®Âà∞Âì™‰∏Ä‰∏™ËßÜÈ¢ë‰∫Ü
          if (i !== this.k) { //ËøôÈáåÂä†Âà§Êñ≠ÊòØÂõ†‰∏∫Ëøô‰∏™ÊñπÊ≥ï‰ºöÊâßË°åÂæàÂ§öÊ¨°Ôºå‰ºöÈÄ†ÊàêÈáçÂ§çËØ∑Ê±ÇÔºåÊâÄ‰ª•ËøôÈáåÂÜô‰∏Ä‰∏™ÈôêÂà∂
            this.k = i //Âà§Êñ≠‰∫ÜÁî®Êà∑Ê≤°ÊúâÊªëÂä®ÔºåÁ°ÆËÆ§‰∫ÜÁî®Êà∑ÁöÑÁ°ÆÊòØÂú®ÁúãËøô‰∏™ËßÜÈ¢ëÔºåÁÑ∂ÂêéÂ∞±ËµãÂÄºÂï¶
            this.dataList[this.k].state = 'play'
			this.id=this.dataList[this.k]._id
            console.log('Ê≠£Âú®Êí≠Êîæ --> Á¨¨' + (this.dataList[this.k]._id) + '‰∏™ËßÜÈ¢ë~')
          }
        }
      },
      async get() {
		  
		 const response = await uni.request({
		   url: `http://192.168.47.9:8080/douyin/feed/?token=${this.token}`, // ÊõøÊç¢‰∏∫‰Ω†ÁöÑÂÆûÈôÖAPI URL
		   method: 'GET',
		   dataType: 'json',
		 });
		 this.userList = response[1].data.video_list
		 
		 // Â§ÑÁêÜËßÜÈ¢ëÂàóË°®Êï∞ÊçÆ
		     this.dataList = this.userList.map(video => {
		       return {
		         _id: String(video.id),
		         src: video.play_url,
		         //cover_url: video.cover_url,
		         like_n: video.favorite_count,
		         sms_n: video.comment_count,
		         like: video.is_favorite,
		         title: "mood",
		         author: {
		           user_id: video.author.id,
		           username: video.author.name,
		           href: video.author.avatar,
		           signature: video.author.signature,
				   background_image:video.author.background_image,
				   follow_count:video.author.follow_count,
				   follower_count:video.author.follower_count,
				   is_follow:video.author.is_follow,
				   total_favorited:video.author.total_favorited,
				   work_count:video.author.work_count,
				   favorite_count:video.author.favorite_count,
		         },
				 state: "pause",
				 msg: video.title,
				 playNumber: 0,//11.Êí≠ÊîæËßÜÈ¢ëÁöÑÊï∞Èáè
				 pinlun: [],//12.ËØÑËÆ∫
				 dubbedText:'@ETÂ§ñÊòü‰∫∫Ë°óËàûÂàõ‰ΩúÁöÑÂéüÂ£∞-ET',//ÈÖçÈü≥ÊñáÂ≠ó
				 playIng: false,//13.Êí≠ÊîæÔºàÈªòËÆ§Ëøô‰∏™Âç≥ÂèØÔºâ
				 isShowimage: false,//14.ÊòØÂê¶ÊòæÁ§∫Â∞ÅÈù¢ÔºàÈªòËÆ§Ëøô‰∏™Âç≥ÂèØÔºâ
				 isShowProgressBarTime: false,//15.ÊòØÂê¶ÊòæÁ§∫ËøõÂ∫¶Êù°ÔºàÈªòËÆ§Ëøô‰∏™Âç≥ÂèØÔºâ
				 isplay: true,//16.ÊòØÂê¶Êí≠ÊîæÈü≥È¢ëÔºàÈªòËÆ§Ëøô‰∏™Âç≥ÂèØÔºâ
				 followText: '+', // ÊàñËÄÖÂÖ∂‰ªñÈªòËÆ§ÂÄº
		         // ÂÖ∂‰ªñËßÜÈ¢ëÂ±ûÊÄß...
		       };
		     });
			 
			
        // Ëøô‰∏™ÊñπÊ≥ï‰∏ªË¶ÅÂ∞±ÊòØÁî®Êù•Á¨¨‰∏ÄÊ¨°ËøõÂÖ•ËßÜÈ¢ëÊí≠ÊîæÊó∂Áî®Êù•Â§ÑÁêÜÁöÑ
        this.dataList[0].state = "play";
        setTimeout(() => {
          //ËøôÈáåÁöÑÂª∂ËøüÊòØ‰∏∫‰∫ÜÈÅøÂÖçÊâßË°åÊó∂Èó¥Â§™Âø´ËÄåÁõ¥Êé•Ë∑≥ËøáÊâßË°åÁöÑ bug
          uni.createVideoContext(this.dataList[0]._id, this).seek(0)
          uni.createVideoContext(this.dataList[0]._id, this).play()
        }, 200)
        this.dataList[this.k].isplay = false
        setTimeout(() => {
          this.dataList[this.k].playIng = true
        }, 500)
        var p = 0
        setTimeout(() => {
          ++p
          uni.createVideoContext(this.dataList[p]._id, this).play()
          setTimeout(() => {
            uni.createVideoContext(this.dataList[p]._id, this).seek(0)
            uni.createVideoContext(this.dataList[p]._id, this).pause()
            console.log('È¢ÑÂä†ËΩΩÁ¨¨' + (p + 1) + '‰∏™ËßÜÈ¢ëÔºö' + this.dataList[p]._id)
          }, 2000)
        }, 50)
      },

      cLike(sss) {
        this.dataList[this.k].like = !this.dataList[this.k].like
        const video = this.dataList[this.k];
        sss ? video.like_n -= 1 : video.like_n += 1;
      },
	  
async toggleLike(item) {
  try {
    const action_type = item.like ? 2 : 1; // Â¶ÇÊûúÂ∑≤ÁªèÁÇπËµûÔºåÂàôÂèñÊ∂àÁÇπËµûÔºõÂ¶ÇÊûúÊú™ÁÇπËµûÔºåÂàôÁÇπËµû
    const response = await uni.request({
      url: `http://192.168.47.9:8080/douyin/favorite/action/?video_id=${this.id}&token=${this.token}&action_type=${action_type}`,
      method: 'POST', // Êé®Ëçê‰ΩøÁî® POST ËØ∑Ê±ÇÔºåÂõ†‰∏∫ÁÇπËµûÊìç‰ΩúÂèØËÉΩ‰ºöÂØπÊï∞ÊçÆËøõË°å‰øÆÊîπ
      dataType: 'json',
    });

    console.log('Response:', response); // Ê∑ªÂä†ËøôË°åËæìÂá∫

    // const data = response[1];
    if (response[1].data.status_code === 0) {
      // ÊàêÂäüÂ§ÑÁêÜ
      item.like = !item.like;// ÂàáÊç¢ÁÇπËµûÁä∂ÊÄÅ
      item.like_n += item.like ? 1 : -1; // Ê†πÊçÆÁÇπËµûÁä∂ÊÄÅ‰øÆÊîπÁÇπËµûÊï∞Èáè
    } else {
      console.error('ÁÇπËµûÂ§±Ë¥•:', data.status_msg || 'Unknown Error');
    }
  } catch (error) {
    console.error('ÁÇπËµûÂ§±Ë¥•:', error);
  }
},

	  
      onpullingdown() {
        // console.log('Ê≠£Âú®‰∏ãÊãâÂà∑Êñ∞ÔºåÊ≠§Êó∂ÊâãËøòÂú®Ëß¶Êë∏Ê≤°ÊúâÊùæÂºÄ')
        this.refreshing = true
      },
      onrefresh() {
        // console.log('‰∏ãÊãâÂà∑Êñ∞ÂÆåÊØïÔºåÊ≠§Êó∂ÊâãÊùæÂºÄ‰∫Ü')
        setTimeout(() => {
          this.refreshing = false
        }, 1000)
      },
      //ÁÇπÂáªÊí≠Êîæ&&ÊöÇÂÅú
      tapVideoHover(state, event) {
        this.dataList[this.k].isShowimage = false
        this.dataList[this.k].isShowProgressBarTime = false
        this.ProgressBarOpacity = 0.5
        this.dotWidth = 0
        console.log('state--', state);
        if (state == 'play' || state == 'continue') {
          this.dataList[this.k].state = 'pause';
        } else {
          this.dataList[this.k].state = 'continue';
        }
        if (this.dataList[this.k].state == 'continue') {
          uni.createVideoContext(this.dataList[this.k]._id, this).play(); //ÊöÇÂÅú‰ª•ÂêéÁªßÁª≠Êí≠Êîæ
        }
        if (this.dataList[this.k].state == 'pause') {
          uni.createVideoContext(this.dataList[this.k]._id, this).pause(); //ÊöÇÂÅú‰ª•ÂêéÁªßÁª≠Êí≠Êîæ
        }
      },
	  

	  
      share() {
        uni.getSubNVueById('forward').show('slide-in-bottom', 200, () => {});
      },
	  

    }
  }
</script>
<style>
  .top_nav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0));
  }

  .top_nav .top_content {
    padding-top: 30upx;
    flex-direction: row;
    align-items: center;
    justify-content: center;
  }

  .top_nav .top_content .player {
    position: absolute;
    left: 20px;
    top: 35upx;
  }

  .top_nav .top_content .img {
    width: 44upx;
    height: 44upx;
  }

  .top_nav .top_content .content_btn {
    flex-direction: row;
    width: 220px;
    align-items: center;
    justify-content: space-around;
  }

  .top_nav .top_content .content_btn .content_item {
    position: relative;
    height: 30px;
  }

  .top_nav .top_content .content_btn .content_item .line_on {
    position: absolute;
    width: 30px;
    height: 2px;
    background-color: #FFFFFF;
    bottom: 0;
    left: 2px;
    border-radius: 4upx;
  }

  .top_nav .top_content .content_btn .content_item .item_title {
    color: #dcdcdc;
    font-size: 36upx;
    font-weight: bold;
  }

  .top_nav .top_content .content_btn .content_item .i_on {
    font-weight: bold;
    font-size: 38upx;
    color: #FFFFFF !important;
  }

  .top_nav .top_content .search {
    position: absolute;
    right: 20px;
    top: 35upx;
  }

  .add {
    position: absolute;
    top: 80upx;
    left: 36upx;
    color: white;
    font-size: 28upx;
    width: 34upx;
    height: 34upx;
    background-color: #F12F5B;
    border-radius: 50%;
    text-align: center;
    line-height: 36upx;
    font-weight: bold;
  }


  .left_dubbedText {
    color: #FFFFFF;
    font-size: 15px;
    flex-direction: row;
    margin-top: 16rpx;
  }

  .left_dubbedText_text {
    color: #eee;
    font-size: 15px;
    line-height: 50upx;
  }

  @keyframes turn {
    0% {
      -webkit-transform: rotate(0deg);
    }

    25% {
      -webkit-transform: rotate(90deg);
    }

    50% {
      -webkit-transform: rotate(180deg);
    }

    75% {
      -webkit-transform: rotate(270deg);
    }

    100% {
      -webkit-transform: rotate(360deg);
    }
  }

  .container {
    background-color: #000000;
  }

  .item {
    /* width : 750rpx; */
    background-color: #000000;
    position: relative;
  }

  .videoHover {
    position: absolute;
    top: 0;
    left: 0;
    flex: 1;
    background-color: rgba(0, 0, 0, 0.1);
    justify-content: center;
    align-items: center;

    /* border-style: dashed;
		border-color: #DD524D;
		border-width: 1px; */
  }

  .playState {
    width: 160rpx;
    height: 160rpx;
    opacity: 0.2;
  }

  .userInfo {
    position: absolute;
    bottom: 110px;
    right: 10px;
    flex-direction: column;

  }

  .userAvatar {
    border-radius: 500%;
    margin-bottom: 15px;
    border-style: solid;
    border-width: 2px;
    border-color: #ffffff;
  }

  .userAvatar {
    width: 100rpx;
    height: 100rpx;
  }

  .likeIco,
  .shareIco,
  .commentIco {
    width: 60rpx;
    height: 60rpx;
    margin-top: 15px;
  }

  .likeNum,
  .commentNum,
  .shareTex {
    color: #ffffff;
    font-size: 30rpx;
    text-align: center;
    margin: 5px;
  }

  .likeNumActive {
    color: red;
  }

  .content {
    width: 720rpx;
    z-index: 99;
    position: absolute;
    bottom: 30px;
    /* justify-content: center; */
    padding: 15rpx;
    flex-direction: column;
    justify-content: flex-start;
    color: #ffffff;
  }

  .userName {
    font-size: 34rpx;
    color: #ffffff;
    margin-top: 80upx;
    font-weight: bold;
  }

  .words {
    margin-top: 16rpx;
    font-size: 30rpx;
    color: #ffffff;

    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
  }

  .root {
    background-color: #000000;
  }
</style>
